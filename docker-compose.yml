services:
  init-db:
    build: .
    container_name: monitoring-init-db
    volumes:
      - ./data:/app/data               # Same volume as main service
      - .:/app                 # Mount app code
    environment:
      - DATABASE_URL=sqlite:///./data/monitoring.db
    command: >
      sh -c "
        echo 'Initializing database...' &&
        python -c '
        import os
        from app.db.models import create_tables
        
        # Check if database file already exists
        db_file = \"/app/data/monitoring.db\"
        if os.path.exists(db_file):
            print(f\"Database already exists at {db_file}\")
            print(\"Skipping initialization\")
        else:
            print(\"Creating database tables...\")
            create_tables()
            print(\"Database initialized successfully\")
        ' &&
        echo 'Database initialization complete'
      "
    # Don't restart this service - it should run once
    restart: "no"

  fastapi-app:
    build: .
    container_name: monitoring-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      - .:/app
      - ./logs:/app/logs
    environment:
      - DATABASE_URL=sqlite:///./data/monitoring.db
      - ENVIRONMENT=production
      - DEBUG=False
    depends_on:
      init-db:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      gunicorn app.main:app \
        --workers 4 \
        --worker-class uvicorn.workers.UvicornWorker \
        --bind 0.0.0.0:8000 \
        --access-logfile - \
        --error-logfile -